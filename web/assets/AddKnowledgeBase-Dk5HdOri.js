import{_ as A,d as M,r as m,C as I,w as $,e as c,j as k,o as v,h as u,f as p,p as z,c as Y,K as Z,L as G,l as H,i as J,n as x,Y as Q,Z as n,ad as W}from"./index-ChCbqBtc.js";import{l as V}from"./lodash-DN9DU0YO.js";import{a as X}from"./index-BD3tVcmV.js";const ee={class:"dialog-footer"},te={__name:"AddKnowledgeBase",props:{visible:{type:Boolean,default:!1},treeSelectedItem:{type:Object,default:()=>({})},treeSelectedCheckbox:{type:Object,default:()=>[]},tableSelectedCheckbox:{type:Object,default:()=>[]},tableDataItem:{type:Object,default:()=>({})},addKnowledgeBaseType:{type:String,default:""}},emits:["update:visible","refresh-list","refresh-table-data-item"],setup(S,{emit:B}){const{proxy:L}=M(),{import_knowledge_base:ae}=L.useDict("import_knowledge_base"),o=S,b=B,g=m(!1),f=m(null),r=I({datasetId:""}),O=I({datasetId:[{required:!0,message:"请选择知识库",trigger:"change"}]}),T=()=>{var a;(a=f.value)==null||a.resetFields(),r.datasetId=""},_=()=>{b("update:visible",!1),T()},j=()=>{_()},q=()=>{r.datasetId=""};let w=m([]);const F=()=>{Q().then(a=>{const{code:e,data:t,msg:l}=a;e===200?w.value=t.data:n.error(""+l)})},K=m([{prop:"title",label:"文件名称",align:"left"},{prop:"dictValue",label:"导入知识库状态",type:"filter",dictionary:"import_knowledge_base",width:150}]),d=m([]),y=m({total:0,pageNum:1,pageSize:10}),R=()=>{const a=o.treeSelectedCheckbox.map(e=>e.id);X(a).then(e=>{const{code:t,data:l,msg:i}=e;t===200&&(l.map(h=>{h.dictValue="0"}),console.log("data",l),d.value=[...d.value,...l])})},N=async()=>{try{g.value=!0;const a={};console.log("form",r.datasetId),Promise.all(d.value.map(e=>W({fileId:e.fileid,datasetId:r.datasetId}).then(t=>{const{code:l,msg:i}=t;return l===200?(e.dictValue="1",{success:!0,item:e}):(n.error(""+i),{success:!1,item:e,error:i})}).catch(t=>(n.error("导入失败："+t.message),{success:!1,item:e,error:t.message})))).then(e=>{const t=e.filter(i=>i.success).length,l=e.length-t;l===0?(setTimeout(()=>{g.value=!1,_(),b("refresh-list")},300),n.success("所有文件导入成功！")):n.warning(`导入完成：${t}个成功，${l}个失败`)}).catch(e=>{n.error("导入过程发生错误："+e.message)})}catch(a){console.error("提交失败:",a),n.error("操作失败，请重试")}finally{}},D=()=>{f.value&&f.value.validate(a=>{a?N():n.error("请检查表单输入")})};$(()=>o.visible,a=>{if(a)if(q(),F(),o.addKnowledgeBaseType==="operation"){if(o.tableDataItem.hasOwnProperty("id")){let e=V.cloneDeep(o.tableDataItem);e.dictValue="0",d.value=[e]}}else{if(o.tableSelectedCheckbox.length){let e=V.cloneDeep(o.tableSelectedCheckbox);e.map(t=>{t.dictValue="0"}),d.value=e}o.treeSelectedCheckbox.length&&R()}else b("refresh-table-data-item"),d.value=[]},{immediate:!0});const U=()=>{D()};return(a,e)=>{const t=c("el-option"),l=c("el-select"),i=c("el-form-item"),h=c("el-form"),E=c("Table"),C=c("el-button"),P=c("el-dialog");return v(),k(P,{title:"添加到知识库",modelValue:o.visible,"onUpdate:modelValue":e[2]||(e[2]=s=>o.visible=s),width:"660px","append-to-body":"","before-close":_},{footer:u(()=>[J("div",ee,[p(C,{onClick:j},{default:u(()=>[x("取消")]),_:1}),p(C,{type:"success",onClick:D,loading:g.value},{default:u(()=>[x(" 导入 ")]),_:1},8,["loading"])])]),default:u(()=>[p(h,{ref_key:"formRef",ref:f,model:r,rules:O,"label-width":"100px",onSubmit:z(U,["prevent"])},{default:u(()=>[p(i,{label:"知识库名称",prop:"datasetId"},{default:u(()=>[p(l,{modelValue:r.datasetId,"onUpdate:modelValue":e[0]||(e[0]=s=>r.datasetId=s),placeholder:"请选择知识库"},{default:u(()=>[(v(!0),Y(Z,null,G(H(w),s=>(v(),k(t,{key:s.name,label:s.name,value:s.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),p(E,{paginationData:y.value,"onUpdate:paginationData":e[1]||(e[1]=s=>y.value=s),tableColumn:K.value,tableData:d.value,showIndex:!0,showPagination:!1},null,8,["paginationData","tableColumn","tableData"])]),_:1},8,["modelValue"])}}},ne=A(te,[["__scopeId","data-v-a3c38285"]]);export{ne as default};
