import{_ as K,d as A,r as m,C as y,w as M,e as d,j as I,o as v,h as c,f,p as P,c as $,K as z,L as Y,l as Z,i as G,n as V,Y as H,Z as s,ad as J}from"./index-ChCbqBtc.js";import{l as Q}from"./lodash-DN9DU0YO.js";import{a as W}from"./index-BD3tVcmV.js";const X={class:"dialog-footer"},ee={__name:"AddKnowledgeBase",props:{visible:{type:Boolean,default:!1},title:{type:String,default:"新增知识库",validator:g=>["新增","修改"].includes(g)},treeSelectedItem:{type:Object,default:()=>({})},treeSelectedCheckbox:{type:Object,default:()=>[]},tableSelectedCheckbox:{type:Object,default:()=>[]}},emits:["update:visible","refresh-list"],setup(g,{emit:S}){const{proxy:B}=A(),{import_knowledge_base:te}=B.useDict("import_knowledge_base"),n=g,C=S,_=m(!1),p=m(null),r=y({datasetId:""}),L=y({datasetId:[{required:!0,message:"请选择知识库",trigger:"change"}]}),q=()=>{var a;(a=p.value)==null||a.resetFields(),r.datasetId=""},b=()=>{C("update:visible",!1),q()},F=()=>{b()},R=()=>{r.datasetId=""};let k=m([]);(()=>{H().then(a=>{const{code:e,data:t,msg:l}=a;e===200?k.value=t.data:s.error(""+l)})})();const j=m([{prop:"title",label:"文件名称",align:"left"},{prop:"dictValue",label:"导入知识库状态",type:"filter",dictionary:"import_knowledge_base",width:150}]),u=m([]),w=m({total:0,pageNum:1,pageSize:10}),N=()=>{const a=n.treeSelectedCheckbox.map(e=>e.id);W(a).then(e=>{const{code:t,data:l,msg:i}=e;t===200&&(l.map(h=>{h.dictValue="0"}),console.log("data",l),u.value=[...u.value,...l])})},O=async()=>{try{_.value=!0;const a={};console.log("form",r.datasetId),Promise.all(u.value.map(e=>J({fileId:e.fileid,datasetId:r.datasetId}).then(t=>{const{code:l,msg:i}=t;return l===200?(e.dictValue="1",{success:!0,item:e}):(s.error(""+i),{success:!1,item:e,error:i})}).catch(t=>(s.error("导入失败："+t.message),{success:!1,item:e,error:t.message})))).then(e=>{const t=e.filter(i=>i.success).length,l=e.length-t;l===0?(setTimeout(()=>{_.value=!1,b(),C("refresh-list")},300),s.success("所有文件导入成功！")):s.warning(`导入完成：${t}个成功，${l}个失败`)}).catch(e=>{s.error("导入过程发生错误："+e.message)})}catch(a){console.error("提交失败:",a),s.error("操作失败，请重试")}finally{}},x=()=>{p.value&&p.value.validate(a=>{a?O():s.error("请检查表单输入")})};M(()=>n.visible,a=>{if(a){if(R(),n.tableSelectedCheckbox.length){let e=Q.cloneDeep(n.tableSelectedCheckbox);e.map(t=>{t.dictValue="0"}),u.value=e}n.treeSelectedCheckbox.length&&N()}else u.value=[]},{immediate:!0});const T=()=>{x()};return(a,e)=>{const t=d("el-option"),l=d("el-select"),i=d("el-form-item"),h=d("el-form"),U=d("Table"),D=d("el-button"),E=d("el-dialog");return v(),I(E,{title:"添加到知识库",modelValue:n.visible,"onUpdate:modelValue":e[2]||(e[2]=o=>n.visible=o),width:"660px","append-to-body":"","before-close":b},{footer:c(()=>[G("div",X,[f(D,{onClick:F},{default:c(()=>[V("取消")]),_:1}),f(D,{type:"success",onClick:x,loading:_.value},{default:c(()=>[V(" 导入 ")]),_:1},8,["loading"])])]),default:c(()=>[f(h,{ref_key:"formRef",ref:p,model:r,rules:L,"label-width":"100px",onSubmit:P(T,["prevent"])},{default:c(()=>[f(i,{label:"知识库名称",prop:"datasetId"},{default:c(()=>[f(l,{modelValue:r.datasetId,"onUpdate:modelValue":e[0]||(e[0]=o=>r.datasetId=o),placeholder:"请选择知识库"},{default:c(()=>[(v(!0),$(z,null,Y(Z(k),o=>(v(),I(t,{key:o.name,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),f(U,{paginationData:w.value,"onUpdate:paginationData":e[1]||(e[1]=o=>w.value=o),tableColumn:j.value,tableData:u.value,showIndex:!0,showPagination:!1},null,8,["paginationData","tableColumn","tableData"])]),_:1},8,["modelValue"])}}},ne=K(ee,[["__scopeId","data-v-f8532d06"]]);export{ne as default};
